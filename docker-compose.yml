# docker-compose.yml
version: "3.9"

services:
  nginxproxymanager:
    image: 'jc21/nginx-proxy-manager:latest'
    environment:
      - PUID=1001
      - PGID=1001
    ports:
      - mode: host
        target: 80
        published: 80
        protocol: tcp
      - mode: host
        target: 81
        published: 81
        protocol: tcp
      - mode: host
        target: 443
        published: 443
        protocol: tcp
    volumes:
      - ./nginx/data/:/data
      - ./nginx/letsencrypt:/etc/letsencrypt
      - ./static:/data/static:ro
      - ./media:/data/media:ro
    networks: [ net ]
    stop_grace_period: 5s
    deploy:
      replicas: 1
      update_config: { parallelism: 1, delay: 10s }
      restart_policy: { condition: on-failure }

  #  pgadmin:
  #    image: dpage/pgadmin4
  #    hostname: pgadmin
  #    environment:
  #      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
  #      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
  #    ports:
  #      - "5050:80"
  #    networks:
  #      - net
  #    deploy:
  #      replicas: 1
  #      update_config:
  #        parallelism: 1
  #        delay: 10s
  #      restart_policy:
  #        condition: on-failure
  #      resources:
  #        limits:
  #          cpus: '0.4'
  #          memory: 256M
  #        reservations:
  #          memory: 128M

  redis:
    user: 1000:1001
    hostname: redis
    image: redis:alpine
    cap_drop: [ ALL ]
    security_opt: [ "no-new-privileges:true" ]
    volumes:
      - ./data/redis/:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf:ro
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      timeout: 5s
      retries: 10
      start_period: 5s
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
    networks: [ net ]
    stop_grace_period: 5s
    deploy:
      replicas: 1
      update_config: { parallelism: 1, delay: 10s }
      resources:
        limits: { cpus: '0.5', memory: 4G }
        reservations: { cpus: '0.25', memory: 512M }

  web:
    hostname: web
    image: localhost:5000/iweb:latest
    user: "1001:1001"
    environment:
      - INTENSIVE_HEALTH_TEST=${INTENSIVE_HEALTH_TEST}
      - DEBUG=${DEBUG}
      - DEBUG_INIT_PAYMENT=${DEBUG_INIT_PAYMENT}
      - DEV=${DEV}
      - HTTPS=${HTTPS}
      - MAIN_DOMAIN=${MAIN_DOMAIN}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - SITE_ID=${SITE_ID}
      - POSTGRES_USE=${POSTGRES_USE}
      - CACHALOT_ENABLED=${CACHALOT_ENABLED}

      - DB_ENGINE=${DB_ENGINE}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}

      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}

      - TZ=${TZ}
      - SECRET_KEY=${SECRET_KEY}

      - EMAIL_HOST=${EMAIL_HOST}
      - EMAIL_HOST_USER=${EMAIL_HOST_USER}
      - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}

      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_RECAPTCHA_SECRET_KEY=${GOOGLE_RECAPTCHA_SECRET_KEY}
      - GOOGLE_RECAPTCHA_SITE_KEY=${GOOGLE_RECAPTCHA_SITE_KEY}

      - VK_AUTH_CLIENT_ID=${VK_AUTH_CLIENT_ID}
      - VK_AUTH_CLIENT_SECRET=${VK_AUTH_CLIENT_SECRET}

      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
      - DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET}

      - YANDEX_CLIENT_ID=${YANDEX_CLIENT_ID}
      - YANDEX_CLIENT_SECRET=${YANDEX_CLIENT_SECRET}
      - YANDEX_RECAPTCHA_SECRET_KEY=${YANDEX_RECAPTCHA_SECRET_KEY}

      - TBANK_TERMINAL_KEY=${TBANK_TERMINAL_KEY}
      - TBANK_TERMINAL_PASSWORD=${TBANK_TERMINAL_PASSWORD}

      - CLOUD_PAYMENT_PUBLIC_ID=${CLOUD_PAYMENT_PUBLIC_ID}
      - CLOUD_PAYMENT_PASSWORD=${CLOUD_PAYMENT_PASSWORD}

      - FK_MERCHANT_ID=${FK_MERCHANT_ID}
      - FK_SECRET_WORD1=${FK_SECRET_WORD1}
      - FK_SECRET_WORD2=${FK_SECRET_WORD2}
      - FK_API_KEY=${FK_API_KEY}

      - CKASSA_LOGIN=${CKASSA_LOGIN}
      - CKASSA_TOKEN=${CKASSA_TOKEN}
      - CKASSA_API_URL=${CKASSA_API_URL}
      - CKASSA_SERV_CODE=${CKASSA_SERV_CODE}

      - RCON_HOST=${RCON_HOST}
      - RCON_PORT=${RCON_PORT}
      - RCON_PASSWORD=${RCON_PASSWORD}

      - LOG_PREFIX=server
    volumes:
      - ./data:/srv/data
      - ./static:/srv/static
      - ./media:/srv/media
      - ./backend/logs:/srv/backend/logs
    ports:
      - "8000:8000"
    healthcheck:
      test: [ "CMD-SHELL", "nc -z localhost 8000 || exit 1" ]
      timeout: 30s
      interval: 5s
      retries: 3
      start_period: 120s
    cap_drop: [ ALL ]
    security_opt: [ "no-new-privileges:true" ]
    tmpfs: [ /tmp ]
    networks: [ net ]
    stop_grace_period: 5s
    deploy:
      replicas: 2
      update_config: { parallelism: 1, delay: 30s }
      restart_policy: { condition: on-failure }

  frontend:
    hostname: frontend
    image: localhost:5000/ifrontend:latest
    user: "1001:1001"
    environment:
      # Для SSR (если потребуется) можно раскомментировать, чтобы ходить к Django по внутреннему имени:
      - NEXT_INTERNAL_API_BASE=http://web:8000
      - NODE_ENV=production
    volumes:
      - ./static:/srv/static:ro
      - ./media:/srv/media:ro
    depends_on: [ web ]
    networks: [ net ]
    read_only: true
    tmpfs:
      - /tmp
      - /app/.next
    deploy:
      replicas: 1
      restart_policy: { condition: on-failure }

  celery:
    hostname: celery
    image: localhost:5000/icelery:latest
    user: "1001:1001"
    volumes:
      - ./data:/srv/data
      - ./static:/srv/static
      - ./media:/srv/media
      - ./backend/logs:/srv/backend/logs
      - ./backend/entrypoint_celery.sh:/srv/entrypoint_celery.sh:ro
    environment:
      - INTENSIVE_HEALTH_TEST=${INTENSIVE_HEALTH_TEST}
      - DEBUG=${DEBUG}
      - DEBUG_INIT_PAYMENT=${DEBUG_INIT_PAYMENT}
      - DEV=${DEV}
      - HTTPS=${HTTPS}
      - MAIN_DOMAIN=${MAIN_DOMAIN}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - SITE_ID=${SITE_ID}
      - POSTGRES_USE=${POSTGRES_USE}
      - CACHALOT_ENABLED=${CACHALOT_ENABLED}

      - DB_ENGINE=${DB_ENGINE}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}

      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}

      - TZ=${TZ}
      - SECRET_KEY=${SECRET_KEY}

      - EMAIL_HOST=${EMAIL_HOST}
      - EMAIL_HOST_USER=${EMAIL_HOST_USER}
      - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}

      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_RECAPTCHA_SECRET_KEY=${GOOGLE_RECAPTCHA_SECRET_KEY}
      - GOOGLE_RECAPTCHA_SITE_KEY=${GOOGLE_RECAPTCHA_SITE_KEY}

      - VK_AUTH_CLIENT_ID=${VK_AUTH_CLIENT_ID}
      - VK_AUTH_CLIENT_SECRET=${VK_AUTH_CLIENT_SECRET}

      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
      - DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET}

      - YANDEX_CLIENT_ID=${YANDEX_CLIENT_ID}
      - YANDEX_CLIENT_SECRET=${YANDEX_CLIENT_SECRET}
      - YANDEX_RECAPTCHA_SECRET_KEY=${YANDEX_RECAPTCHA_SECRET_KEY}

      - TBANK_TERMINAL_KEY=${TBANK_TERMINAL_KEY}
      - TBANK_TERMINAL_PASSWORD=${TBANK_TERMINAL_PASSWORD}

      - CLOUD_PAYMENT_PUBLIC_ID=${CLOUD_PAYMENT_PUBLIC_ID}
      - CLOUD_PAYMENT_PASSWORD=${CLOUD_PAYMENT_PASSWORD}

      - FK_MERCHANT_ID=${FK_MERCHANT_ID}
      - FK_SECRET_WORD1=${FK_SECRET_WORD1}
      - FK_SECRET_WORD2=${FK_SECRET_WORD2}
      - FK_API_KEY=${FK_API_KEY}

      - CKASSA_LOGIN=${CKASSA_LOGIN}
      - CKASSA_TOKEN=${CKASSA_TOKEN}
      - CKASSA_API_URL=${CKASSA_API_URL}
      - CKASSA_SERV_CODE=${CKASSA_SERV_CODE}

      - RCON_HOST=${RCON_HOST}
      - RCON_PORT=${RCON_PORT}
      - RCON_PASSWORD=${RCON_PASSWORD}

      - LOG_PREFIX=celery
    networks: [ net ]
    stop_grace_period: 2s
    cap_drop: [ ALL ]
    security_opt: [ "no-new-privileges:true" ]
    tmpfs: [ /tmp ]
    deploy:
      replicas: 1
      update_config: { parallelism: 1, delay: 10s }
      restart_policy: { condition: on-failure }

  beat:
    hostname: beat
    image: localhost:5000/ibeat:latest
    user: "1001:1001"
    volumes:
      - ./data:/srv/data
      - ./static:/srv/static
      - ./media:/srv/media
      - ./backend/logs:/srv/backend/logs
      - ./backend/entrypoint_beat.sh:/srv/entrypoint_beat.sh:ro
    environment:
      - INTENSIVE_HEALTH_TEST=${INTENSIVE_HEALTH_TEST}
      - DEBUG=${DEBUG}
      - DEBUG_INIT_PAYMENT=${DEBUG_INIT_PAYMENT}
      - DEV=${DEV}
      - HTTPS=${HTTPS}
      - MAIN_DOMAIN=${MAIN_DOMAIN}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - SITE_ID=${SITE_ID}
      - POSTGRES_USE=${POSTGRES_USE}
      - CACHALOT_ENABLED=${CACHALOT_ENABLED}

      - DB_ENGINE=${DB_ENGINE}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}

      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}

      - TZ=${TZ}
      - SECRET_KEY=${SECRET_KEY}

      - EMAIL_HOST=${EMAIL_HOST}
      - EMAIL_HOST_USER=${EMAIL_HOST_USER}
      - EMAIL_HOST_PASSWORD=${EMAIL_HOST_PASSWORD}

      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_RECAPTCHA_SECRET_KEY=${GOOGLE_RECAPTCHA_SECRET_KEY}
      - GOOGLE_RECAPTCHA_SITE_KEY=${GOOGLE_RECAPTCHA_SITE_KEY}

      - VK_AUTH_CLIENT_ID=${VK_AUTH_CLIENT_ID}
      - VK_AUTH_CLIENT_SECRET=${VK_AUTH_CLIENT_SECRET}

      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
      - DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET}

      - YANDEX_CLIENT_ID=${YANDEX_CLIENT_ID}
      - YANDEX_CLIENT_SECRET=${YANDEX_CLIENT_SECRET}
      - YANDEX_RECAPTCHA_SECRET_KEY=${YANDEX_RECAPTCHA_SECRET_KEY}

      - TBANK_TERMINAL_KEY=${TBANK_TERMINAL_KEY}
      - TBANK_TERMINAL_PASSWORD=${TBANK_TERMINAL_PASSWORD}

      - CLOUD_PAYMENT_PUBLIC_ID=${CLOUD_PAYMENT_PUBLIC_ID}
      - CLOUD_PAYMENT_PASSWORD=${CLOUD_PAYMENT_PASSWORD}

      - FK_MERCHANT_ID=${FK_MERCHANT_ID}
      - FK_SECRET_WORD1=${FK_SECRET_WORD1}
      - FK_SECRET_WORD2=${FK_SECRET_WORD2}
      - FK_API_KEY=${FK_API_KEY}

      - CKASSA_LOGIN=${CKASSA_LOGIN}
      - CKASSA_TOKEN=${CKASSA_TOKEN}
      - CKASSA_API_URL=${CKASSA_API_URL}
      - CKASSA_SERV_CODE=${CKASSA_SERV_CODE}

      - RCON_HOST=${RCON_HOST}
      - RCON_PORT=${RCON_PORT}
      - RCON_PASSWORD=${RCON_PASSWORD}

      - LOG_PREFIX=beat
    networks: [ net ]
    stop_grace_period: 2s
    cap_drop: [ ALL ]
    security_opt: [ "no-new-privileges:true" ]
    tmpfs: [ /tmp ]
    deploy:
      replicas: 1
      update_config: { parallelism: 1, delay: 10s }
      restart_policy: { condition: on-failure }

  #  flower:
  #    hostname: flower
  #    image: localhost:5000/iflower:latest
  #    environment:
  #      - FLOWER_USER=${FLOWER_USER}
  #      - FLOWER_PASSWORD=${FLOWER_PASSWORD}
  #    volumes:
  #      - ./backend/logs:/srv/backend/logs
  #      - ./backend/entrypoint_flower.sh:/srv/entrypoint_flower.sh
  #    ports:
  #      - "5555:5555"
  #    networks:
  #      - net
  #    deploy:
  #      replicas: 1
  #      update_config:
  #        parallelism: 1
  #        delay: 10s
  #      restart_policy:
  #        condition: on-failure
  #      resources:
  #        limits:
  #          cpus: '0.5'
  #          memory: 256M
  #        reservations:
  #          cpus: '0.25'
  #          memory: 128M

  # --- sonar stack -------------------------------------------------
  sonardb:
    image: postgres:16-alpine
    hostname: sonardb
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonar
      - POSTGRES_DB=sonar
    volumes:
      - ./data/sonar_db:/var/lib/postgresql/data
    networks: [ net ]
    cap_drop: [ ALL ]
    security_opt: [ "no-new-privileges:true" ]
    tmpfs: [ /tmp ]
    deploy:
      replicas: 1
      restart_policy: { condition: on-failure }

  sonarqube:
    image: sonarqube:10.5.1-community
    ulimits:
      nproc: 8192
      nofile: { soft: 131072, hard: 131072 }
    hostname: sonarqube
    depends_on: [ sonardb ]
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://sonardb:5432/sonar
      - SONAR_JDBC_USERNAME=sonar
      - SONAR_JDBC_PASSWORD=sonar
    volumes:
      - ./data/sonarqube/data:/opt/sonarqube/data
      - ./data/sonarqube/extensions:/opt/sonarqube/extensions
      - ./data/sonarqube/logs:/opt/sonarqube/logs
    networks: [ net ]
    cap_drop: [ ALL ]
    security_opt: [ "no-new-privileges:true" ]
    tmpfs: [ /tmp ]
    deploy:
      replicas: 1
      restart_policy: { condition: on-failure }

networks:
  net:
    driver: overlay
